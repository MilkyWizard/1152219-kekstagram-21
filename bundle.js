(()=>{"use strict";window.backend=function(){let e=function(e){let t=new XMLHttpRequest;t.responseType="json",t.addEventListener("load",(function(){200===t.status?e.onSuccess(t.response):e.onError("Статус ответа: "+t.status+" "+t.statusText)})),t.addEventListener("error",(function(){e.onError("Произошла ошибка соединения")})),t.addEventListener("timeout",(function(){e.onError("Запрос не успел выполниться за "+t.timeout+"мс")})),t.timeout=1e4,t.open(e.method,e.url),t.send(e.data)};return{loadPhotos:function(t,n){e({method:"GET",url:"https://21.javascript.pages.academy/kekstagram/data",data:null,onSuccess:t,onError:n})},sendPhoto:function(t,n,o){e({method:"POST",data:t,url:"https://21.javascript.pages.academy/kekstagram",onSuccess:n,onError:o})}}}(),window.comment=function(){let e=document.querySelector(".big-picture").querySelector(".social__comments"),t=e.querySelector(".social__comment");return{render:function(n){let o=document.createDocumentFragment();n.forEach((function(e){let n=function(e){let n=t.cloneNode(!0),o=n.querySelector(".social__picture"),r=n.querySelector(".social__text");return o.src=e.avatar,o.alt=e.name,r.textContent=e.message,n}(e);o.appendChild(n)})),e.textContent="",e.appendChild(o)}}}(),window.debounce=function(e){let t;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}},window.editor=function(){let e=document.querySelector("body"),t=document.querySelector(".img-upload__overlay"),n=document.querySelector(".img-upload__input"),o=document.querySelector(".img-upload__cancel"),r=document.querySelector(".img-upload__form"),c=document.querySelector(".text__hashtags"),i=document.querySelector(".text__description"),u=function(e){e.keyCode===window.utils.ESC_KEY&&s()},s=function(){t.classList.add("hidden"),e.classList.remove("modal-open"),c.style.border="2px solid transparent",d(),window.scale.reset(),window.effect.reset(),window.hashtags.reset(),o.removeEventListener("click",s),document.removeEventListener("keydown",u),r.removeEventListener("submit",l)},l=function(e){e.preventDefault(),window.backend.sendPhoto(new FormData(r),window.popups.showLoadSuccess,window.popups.showLoadError),s()},d=function(){n.value="",c.value="",i.value=""};n.addEventListener("change",(function(){t.classList.remove("hidden"),e.classList.add("modal-open"),window.upload.addNewImg(),window.scale.init(),window.effect.init(),window.hashtags.init(),o.addEventListener("click",s),document.addEventListener("keydown",u),r.addEventListener("submit",l)}))}(),window.effect=function(){let e=document.querySelector(".effect-level"),t=document.querySelectorAll(".effects__radio"),n=document.querySelector(".img-upload__preview img"),o=document.querySelector(".effect-level__value"),r=document.querySelector(".effect-level__line"),c=document.querySelector(".effect-level__pin"),i=document.querySelector(".effect-level__depth"),u=null,s={chrome:{setSaturation(e){n.style.filter="grayscale("+e+")"},className:"effects__preview--chrome"},sepia:{setSaturation(e){n.style.filter="sepia("+e+")"},className:"effects__preview--sepia"},marvin:{setSaturation(e){n.style.filter="invert("+100*e+"%)"},className:"effects__preview--marvin"},phobos:{setSaturation(e){n.style.filter="blur("+3*e+"px)"},className:"effects__preview--phobos"},heat:{setSaturation(e){n.style.filter="brightness("+(2*e+1)+")"},className:"effects__preview--heat"}},l=function(){u&&n.classList.remove(u.className)},d=function(t){l(),u=s[t.target.value],u?(e.classList.remove("hidden"),n.classList.add(u.className),a(1),m(1)):y()},a=function(e){u.setSaturation(e),o.value=Math.round(100*e)},m=function(e){let t=100*e;c.style.left=t+"%",i.style.width=t+"%"},f=function(e){let t=v(e);a(t),m(t)},v=function(e){let t=r.getBoundingClientRect(),n=(e.clientX-t.left)/t.width;return Math.min(1,Math.max(0,n))},w=function(){document.removeEventListener("mousemove",f),document.removeEventListener("mouseup",w)},p=function(){document.addEventListener("mouseup",w),document.addEventListener("mousemove",f)},y=function(){l(),n.style.filter="",e.classList.add("hidden"),o.value=100,u=null,t[0].checked=!0};return{init:function(){y(),r.addEventListener("mouseup",f),c.addEventListener("mousedown",p);for(let e=0;e<t.length;e++)t[e].addEventListener("change",d)},reset:function(){w(),r.removeEventListener("mouseup",f),c.removeEventListener("mousedown",p);for(let e=0;e<t.length;e++)t[e].removeEventListener("change",d)}}}(),window.filter=function(){let e=document.querySelectorAll(".img-filters__button"),t={0:"initial",1:"random",2:"discussed"},n=0,o=[];return e.forEach((function(r,c){r.addEventListener("click",(function(r){e[n].classList.remove("img-filters__button--active"),r.target.classList.add("img-filters__button--active"),n=c,o.forEach((function(e){e(t[n])}))}))})),{onChange:function(e){o.push(e)}}}(),window.hashtags=function(){const e=/^#[a-zA-Zа-яА-ЯёЁ0-9]+$/;let t=document.querySelector(".text__hashtags"),n=document.querySelector(".text__description"),o=document.querySelector(".img-upload__submit"),r=function(t){let n=c(t);for(let t=0;t<n.length;t++){let r=(o=n[t]).length<2?"Минимальная длина одного хэш-тега 2 символа, включая решётку":o.length>20?"Максимальная длина одного хэш-тега 20 символов, включая решётку":e.test(o)?"":"Хэш-тег должен начинаться с # и содержать только буквы и цифры";if(r)return r}var o;return n.length>5?"Нельзя указать больше пяти хэш-тегов":function(e){let t=[];for(let n=0;n<e.length;n++){if(t.includes(e[n]))return!1;t.push(e[n])}return!0}(n)?"":"Один и тот же хэш-тег не может быть использован дважды"},c=function(e){return e.toLowerCase().split(" ").filter(Boolean)},i=function(e){e.keyCode===window.utils.ESC_KEY&&e.stopPropagation()},u=function(e){let t=e.target.value,n=r(t);e.target.setCustomValidity(n),s()},s=function(){t.style.border=""},l=function(){r(t.value)?t.style.border="2px solid red":s()};return{reset:function(){n.removeEventListener("keydown",i),o.removeEventListener("click",l),t.removeEventListener("keydown",i),t.removeEventListener("input",u)},init:function(){n.addEventListener("keydown",i),o.addEventListener("click",l),t.addEventListener("keydown",i),t.addEventListener("input",u)}}}(),window.photos=function(){let e=document.querySelector("#picture").content.querySelector(".picture"),t=document.querySelector(".pictures"),n=document.querySelector(".img-filters"),o=[],r=function(n){t.querySelectorAll(".picture").forEach((function(e){e.remove()}));let o=document.createDocumentFragment();n.forEach((function(t){let n=function(t){let n=e.cloneNode(!0);return n.querySelector(".picture__img").src=t.url,n.querySelector(".picture__likes").textContent=t.likes,n.querySelector(".picture__comments").textContent=t.comments.length,n}(t);!function(e,t){e.addEventListener("click",(function(){window.preview.showBigPicture(t)}))}(n,t),o.appendChild(n)})),t.appendChild(o)},c=window.debounce((function(e){r("random"===e?window.utils.getRandomArray(o,10):"discussed"===e?o.slice(0).sort((function(e,t){return t.comments.length-e.comments.length})):o)}));window.filter.onChange(c),window.backend.loadPhotos((function(e){r(e),o=e,n.classList.remove("img-filters--inactive")}),(function(){}))}(),window.popups=function(){let e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success"),n=document.querySelector("#error").content.querySelector(".error"),o=function(t){e.appendChild(t);let n=function(){t.remove(),t.removeEventListener("click",o),document.removeEventListener("click",c),document.removeEventListener("keydown",r)},o=function(e){"BUTTON"===e.target.nodeName&&n()},r=function(e){e.keyCode===window.utils.ESC_KEY&&n()},c=function(e){"SECTION"===e.target.nodeName&&n()};t.addEventListener("click",o),document.addEventListener("click",c),document.addEventListener("keydown",r)};return{showLoadSuccess:function(){let e=t.cloneNode(!0);o(e)},showLoadError:function(){let e=n.cloneNode(!0);o(e)}}}(),window.preview=function(){let e=document.querySelector("body"),t=document.querySelector(".big-picture"),n=t.querySelector(".big-picture__img img"),o=t.querySelector(".likes-count"),r=t.querySelector(".comments-count"),c=t.querySelector(".social__caption"),i=document.querySelector(".big-picture__cancel"),u=document.querySelector(".social__footer-text"),s=t.querySelector(".comments-loader"),l=t.querySelector(".social__comment-count"),d=0,a=[],m=function(e){l.textContent=e.length+" из "+a.length+" комментариев"},f=function(){t.classList.add("hidden"),e.classList.remove("modal-open"),document.removeEventListener("keydown",v),i.removeEventListener("click",h),u.removeEventListener("keydown",w),s.removeEventListener("click",g)},v=function(e){e.keyCode===window.utils.ESC_KEY&&f()},w=function(e){e.keyCode===window.utils.ESC_KEY&&e.stopPropagation()},p=function(){return 5*d},y=function(){return d+=1,a.slice(0,p())},_=function(){return a.length<=p()},h=function(){f()},g=function(){let e=y();window.comment.render(e),_()&&s.classList.add("hidden"),m(e)};return{showBigPicture:function(l){d=0,a=l.comments,n.src=l.url,o.textContent=l.likes,r.textContent=l.comments.length,c.textContent=l.description;let f=y();window.comment.render(f),_()?s.classList.add("hidden"):s.classList.remove("hidden"),m(f),t.classList.remove("hidden"),e.classList.add("modal-open"),document.addEventListener("keydown",v),i.addEventListener("click",h),u.addEventListener("keydown",w),s.addEventListener("click",g)}}}(),window.scale=function(){const e=document.querySelector(".scale__control--value"),t=document.querySelector(".img-upload__preview"),n=document.querySelector(".scale__control--smaller"),o=document.querySelector(".scale__control--bigger"),r=function(){return parseInt(e.value,10)},c=function(){const e=r();u(e<100?e+25:e)},i=function(){const e=r();u(e>25?e-25:e)},u=function(n){e.value=n+"%",t.style.transform="scale("+n/100+")"};return{init:function(){u(100),o.addEventListener("click",c),n.addEventListener("click",i)},reset:function(){o.removeEventListener("click",c),n.removeEventListener("click",i)}}}(),window.upload=function(){let e=["gif","jpg","jpeg","png"],t=document.querySelector(".img-upload__preview img"),n=document.querySelectorAll(".effects__preview"),o=document.querySelector(".img-upload__input"),r=function(e){t.src=e,n.forEach((function(t){t.style.backgroundImage="url("+e+")"}))};return{addNewImg:function(){r("img/upload-default-image.jpg");let t=o.files[0],n=t.name.toLowerCase();if(e.some((function(e){return n.endsWith(e)}))){let e=URL.createObjectURL(t);r(e)}}}}(),window.utils={getRandomArray:function(e,t){return e.slice(0).sort((function(){return Math.random()-.5})).splice(0,t)},getRandomValue:function(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e},ESC_KEY:27,ENTER_KEY:13}})();